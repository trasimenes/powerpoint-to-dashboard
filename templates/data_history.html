{% extends 'base.html' %}
{% block title %}Data History - CPFR Dashboard{% endblock %}

{% block content %}
<!-- Webpixels CSS -->
<link href="https://unpkg.com/@webpixels/css@1.1.5/dist/index.css" rel="stylesheet">

<!-- Additional CSS for modern dashboard -->
<style>
    .collaborative-table {
        border-collapse: collapse;
        width: 100%;
        table-layout: fixed;
    }
    
    .collaborative-table th,
    .collaborative-table td {
        border: 1px solid #dee2e6;
        padding: 8px;
        position: relative;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .collaborative-table th {
        background-color: #f8f9fa;
        font-weight: 600;
        text-align: center;
    }
    
    .editable-cell {
        min-height: 25px;
        outline: none;
        cursor: text;
        width: 80px;
        min-width: 80px;
        max-width: 80px;
        text-align: center;
        font-size: 0.8rem;
    }
    
    .editable-cell:focus {
        background-color: #fff3cd;
        border: 2px solid #ffc107;
    }
    
    .editable-cell:hover {
        background-color: #f8f9fa;
    }
    
    .week-header {
        background-color: #0d6efd;
        color: white;
        text-align: center;
        width: 80px;
        min-width: 80px;
        max-width: 80px;
        font-size: 0.8rem;
    }
    
    .week-header.week-cell,
    .week-header.date-cell,
    .week-header.status-cell {
        background-color: #0d6efd;
        color: white;
        text-align: center;
        font-weight: 600;
    }

    /* Modern dashboard styling */
    .dashboard-main {
        background-color: #f8f9fb;
        min-height: 100vh;
    }
    
    .kpi-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s, box-shadow 0.2s;
        border: 0;
    }
    
    .kpi-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    }
    
    .kpi-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
    }
    
    .kpi-value {
        font-size: 2rem;
        font-weight: 700;
        color: #1f2937;
        margin: 0;
    }
    
    .kpi-label {
        font-size: 0.875rem;
        color: #6b7280;
        font-weight: 500;
        margin-bottom: 0.5rem;
    }
    
    .kpi-change {
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .module-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        border: 0;
        margin-bottom: 2rem;
    }
    
    .module-card .card-header {
        background: transparent;
        border-bottom: 1px solid #e5e7eb;
        padding: 1.5rem 1.5rem 1rem;
    }
    
    .module-card .card-body {
        padding: 1.5rem;
    }
    
    .dashboard-header {
        background: white;
        border-bottom: 1px solid #e5e7eb;
        padding: 1.5rem 0;
    }
    
    .nav-tabs .nav-link {
        border: none;
        background: transparent;
        color: #6b7280;
        padding: 0.5rem 1rem;
        margin-right: 0.5rem;
        border-radius: 6px;
        font-weight: 500;
    }
    
    .nav-tabs .nav-link.active {
        background: #3b82f6;
        color: white;
    }
    
    .nav-tabs .nav-link:hover {
        background: #f3f4f6;
        color: #374151;
    }
    
    .nav-tabs .nav-link.active:hover {
        background: #2563eb;
        color: white;
    }
    
    .table-responsive {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
    }
</style>

<!-- Dashboard -->
<div class="d-flex flex-column flex-lg-row h-lg-full">
    {% include 'partials/navigation.html' %}
    
    <!-- Main content -->
    <div class="h-screen flex-grow-1 overflow-y-lg-auto dashboard-main">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="container-fluid">
                <div class="row align-items-center">
                    <div class="col-sm-6 col-12">
                        <h1 class="h2 mb-0 ls-tight">Data History</h1>
                        <p class="text-muted mb-0">Données historiques avec comparaisons hebdomadaires et annuelles</p>
                    </div>
                    <div class="col-sm-6 col-12 text-sm-end">
                        <div class="mx-n1">
                            <span id="connection-status" class="badge bg-success">● Connected</span>
                            <div id="online-users" class="d-inline-block ms-2">
                                <!-- Dynamic user list -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Main -->
        <main class="py-6">
            <div class="container-fluid">


<!-- Module: Nb of sessions -->
<div class="row mb-5" id="sessions">
    <div class="col-12">
        <div class="card module-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-people me-2"></i>Nb of sessions
                </h5>
                <!-- Tab Navigation -->
                <ul class="nav nav-tabs mt-3" id="sessions-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="sessions-weekly-tab" data-bs-toggle="tab" data-bs-target="#sessions-weekly" type="button" role="tab">
                            Weekly
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="sessions-yoy-tab" data-bs-toggle="tab" data-bs-target="#sessions-yoy" type="button" role="tab">
                            Year on Year
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <!-- Tab Content -->
                <div class="tab-content" id="sessions-tab-content">
                    <!-- Weekly Tab -->
                    <div class="tab-pane fade show active" id="sessions-weekly" role="tabpanel">
                        <div class="table-responsive mb-4">
                            <table id="sessions-weekly-table" class="table table-bordered">
                                <thead class="table-primary">
                                    <tr id="sessions-weekly-header">
                                        <!-- Week headers will be inserted here -->
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr id="sessions-weekly-data">
                                        <!-- Session values will be inserted here -->
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="sessions-weekly-chart" style="height: 300px;">
                            <canvas id="sessions-weekly-canvas"></canvas>
                        </div>
                    </div>
                    
                    <!-- Year on Year Tab -->
                    <div class="tab-pane fade" id="sessions-yoy" role="tabpanel">
                        <div class="table-responsive mb-4">
                            <table id="sessions-yoy-table" class="table table-bordered">
                                <thead class="table-primary">
                                    <tr id="sessions-yoy-header">
                                        <!-- Year headers will be inserted here -->
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr id="sessions-yoy-data">
                                        <!-- Session values will be inserted here -->
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="sessions-yoy-chart" style="height: 300px;">
                            <canvas id="sessions-yoy-canvas"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Module: Web B2C Global revenue -->
<div class="row mb-5" id="revenue">
    <div class="col-12">
        <div class="card module-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-currency-euro me-2"></i>Web B2C Global revenue
                </h5>
                <!-- Tab Navigation -->
                <ul class="nav nav-tabs mt-3" id="revenue-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="revenue-weekly-tab" data-bs-toggle="tab" data-bs-target="#revenue-weekly" type="button" role="tab">
                            Weekly
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="revenue-yoy-tab" data-bs-toggle="tab" data-bs-target="#revenue-yoy" type="button" role="tab">
                            Year on Year
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <!-- Tab Content -->
                <div class="tab-content" id="revenue-tab-content">
                    <!-- Weekly Tab -->
                    <div class="tab-pane fade show active" id="revenue-weekly" role="tabpanel">
                        <div class="table-responsive mb-4">
                            <table id="revenue-weekly-table" class="table table-bordered">
                                <thead class="table-primary">
                                    <tr id="revenue-weekly-header">
                                        <!-- Week headers will be inserted here -->
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr id="revenue-weekly-data">
                                        <!-- Revenue values will be inserted here -->
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="revenue-weekly-chart" style="height: 300px;">
                            <canvas id="revenue-weekly-canvas"></canvas>
                        </div>
                    </div>
                    
                    <!-- Year on Year Tab -->
                    <div class="tab-pane fade" id="revenue-yoy" role="tabpanel">
                        <div class="table-responsive mb-4">
                            <table id="revenue-yoy-table" class="table table-bordered">
                                <thead class="table-primary">
                                    <tr id="revenue-yoy-header">
                                        <!-- Year headers will be inserted here -->
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr id="revenue-yoy-data">
                                        <!-- Revenue values will be inserted here -->
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="revenue-yoy-chart" style="height: 300px;">
                            <canvas id="revenue-yoy-canvas"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Module: Average basket value -->
<div class="row mb-5" id="basket">
    <div class="col-12">
        <div class="card module-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-cart3 me-2"></i>Average basket value
                </h5>
                <!-- Tab Navigation -->
                <ul class="nav nav-tabs mt-3" id="basket-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="basket-weekly-tab" data-bs-toggle="tab" data-bs-target="#basket-weekly" type="button" role="tab">
                            Weekly
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="basket-yoy-tab" data-bs-toggle="tab" data-bs-target="#basket-yoy" type="button" role="tab">
                            Year on Year
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <!-- Tab Content -->
                <div class="tab-content" id="basket-tab-content">
                    <!-- Weekly Tab -->
                    <div class="tab-pane fade show active" id="basket-weekly" role="tabpanel">
                        <div class="table-responsive mb-4">
                            <table id="basket-weekly-table" class="table table-bordered">
                                <thead class="table-primary">
                                    <tr id="basket-weekly-header">
                                        <!-- Week headers will be inserted here -->
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr id="basket-weekly-data">
                                        <!-- Basket values will be inserted here -->
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="basket-weekly-chart" style="height: 300px;">
                            <canvas id="basket-weekly-canvas"></canvas>
                        </div>
                    </div>
                    
                    <!-- Year on Year Tab -->
                    <div class="tab-pane fade" id="basket-yoy" role="tabpanel">
                        <div class="table-responsive mb-4">
                            <table id="basket-yoy-table" class="table table-bordered">
                                <thead class="table-primary">
                                    <tr id="basket-yoy-header">
                                        <!-- Year headers will be inserted here -->
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr id="basket-yoy-data">
                                        <!-- Basket values will be inserted here -->
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="basket-yoy-chart" style="height: 300px;">
                            <canvas id="basket-yoy-canvas"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Module: Conversion rate -->
<div class="row mb-5" id="conversion">
    <div class="col-12">
        <div class="card module-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-percent me-2"></i>Conversion rate
                </h5>
                <!-- Tab Navigation -->
                <ul class="nav nav-tabs mt-3" id="conversion-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="conversion-weekly-tab" data-bs-toggle="tab" data-bs-target="#conversion-weekly" type="button" role="tab">
                            Weekly
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="conversion-yoy-tab" data-bs-toggle="tab" data-bs-target="#conversion-yoy" type="button" role="tab">
                            Year on Year
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <!-- Tab Content -->
                <div class="tab-content" id="conversion-tab-content">
                    <!-- Weekly Tab -->
                    <div class="tab-pane fade show active" id="conversion-weekly" role="tabpanel">
                        <div class="table-responsive mb-4">
                            <table id="conversion-weekly-table" class="table table-bordered">
                                <thead class="table-primary">
                                    <tr id="conversion-weekly-header">
                                        <!-- Week headers will be inserted here -->
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr id="conversion-weekly-data">
                                        <!-- Conversion values will be inserted here -->
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="conversion-weekly-chart" style="height: 300px;">
                            <canvas id="conversion-weekly-canvas"></canvas>
                        </div>
                    </div>
                    
                    <!-- Year on Year Tab -->
                    <div class="tab-pane fade" id="conversion-yoy" role="tabpanel">
                        <div class="table-responsive mb-4">
                            <table id="conversion-yoy-table" class="table table-bordered">
                                <thead class="table-primary">
                                    <tr id="conversion-yoy-header">
                                        <!-- Year headers will be inserted here -->
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr id="conversion-yoy-data">
                                        <!-- Conversion values will be inserted here -->
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="conversion-yoy-chart" style="height: 300px;">
                            <canvas id="conversion-yoy-canvas"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Module: Nb of bookings -->
<div class="row mb-5" id="bookings">
    <div class="col-12">
        <div class="card module-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-calendar-check me-2"></i>Nb of bookings
                </h5>
                <!-- Tab Navigation -->
                <ul class="nav nav-tabs mt-3" id="bookings-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="bookings-weekly-tab" data-bs-toggle="tab" data-bs-target="#bookings-weekly" type="button" role="tab">
                            Weekly
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="bookings-yoy-tab" data-bs-toggle="tab" data-bs-target="#bookings-yoy" type="button" role="tab">
                            Year on Year
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <!-- Tab Content -->
                <div class="tab-content" id="bookings-tab-content">
                    <!-- Weekly Tab -->
                    <div class="tab-pane fade show active" id="bookings-weekly" role="tabpanel">
                        <div class="table-responsive mb-4">
                            <table id="bookings-weekly-table" class="table table-bordered">
                                <thead class="table-primary">
                                    <tr id="bookings-weekly-header">
                                        <!-- Week headers will be inserted here -->
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr id="bookings-weekly-data">
                                        <!-- Bookings values will be inserted here -->
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="bookings-weekly-chart" style="height: 300px;">
                            <canvas id="bookings-weekly-canvas"></canvas>
                        </div>
                    </div>
                    
                    <!-- Year on Year Tab -->
                    <div class="tab-pane fade" id="bookings-yoy" role="tabpanel">
                        <div class="table-responsive mb-4">
                            <table id="bookings-yoy-table" class="table table-bordered">
                                <thead class="table-primary">
                                    <tr id="bookings-yoy-header">
                                        <!-- Year headers will be inserted here -->
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr id="bookings-yoy-data">
                                        <!-- Bookings values will be inserted here -->
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="bookings-yoy-chart" style="height: 300px;">
                            <canvas id="bookings-yoy-canvas"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading indicator -->
<div id="loading" class="text-center mt-4" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Synchronisation en cours...</p>
</div>

<!-- Socket.IO -->
<script src="/socket.io/socket.io.js"></script>

<!-- Chart.js 4.5.0 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.0/dist/chart.umd.js"></script>

<!-- Yjs for collaborative editing -->
<script src="https://cdn.jsdelivr.net/npm/yjs@13.5.0/dist/yjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/y-websocket@1.4.5/dist/y-websocket.min.js"></script>

<script>
    // Global variables
    let socket = null;
    let ydoc = null;
    let yTable = null;
    let provider = null;
    let currentUser = null;
    let onlineUsers = new Map();
    let currentModule = 'weekly';
    let allData = null;

    // Data structure - Comprehensive CPFR metrics from SQLite
    const SECTION_ORDER = [
        'SLIDE_31_GLOBAL', 'SLIDE_31_OFFERS', 'SLIDE_31_BOOKINGS',
        'SEA', 'SEO', 'OM', 'CRM', 'SEO_DETAIL'
    ];
    
    const SECTION_LABELS = {
        'SLIDE_31_GLOBAL': 'Global KPIs (Slide 31)',
        'SLIDE_31_OFFERS': 'Offers Focus (Slide 31)',
        'SLIDE_31_BOOKINGS': 'Bookings Details (Slide 31)',
        'SEA': 'SEA - Acquisition (Slide 32)',
        'SEO': 'SEO - Acquisition (Slide 32)',
        'OM': 'OM - Acquisition (Slide 32)',
        'CRM': 'CRM - Acquisition (Slide 32)',
        'SEO_DETAIL': 'SEO Details (Slide 32)'
    };

    // Dynamic metrics - will be populated from server data
    let METRICS = {};

    // Initialize the application
    document.addEventListener('DOMContentLoaded', initializeApp);
    
    // Module switching functions
    function showModule(module) {
        currentModule = module;
        
        // Update buttons
        document.getElementById('btn-weekly').className = module === 'weekly' ? 'btn btn-primary' : 'btn btn-outline-primary';
        document.getElementById('btn-yearly').className = module === 'yearly' ? 'btn btn-primary' : 'btn btn-outline-primary';
        
        // Show/hide modules
        document.getElementById('module-weekly').style.display = module === 'weekly' ? 'block' : 'none';
        document.getElementById('module-yearly').style.display = module === 'yearly' ? 'block' : 'none';
        
        // Render appropriate data
        if (allData) {
            renderModuleData(module);
        }
    }
    
    function renderModuleData(module) {
        if (module === 'weekly') {
            renderWeeklyData();
        } else if (module === 'yearly') {
            renderYearlyData();
        }
    }
    
    function renderWeeklyData() {
        console.log('Rendering weekly data...');
        if (!allData) {
            console.error('No data available for weekly rendering');
            return;
        }
        
        // Show last 12 weeks
        const weeklyWeeks = allData.weeks.slice(0, 12);
        console.log('Weekly weeks:', weeklyWeeks);
        
        renderTableHeaders(weeklyWeeks, 'weekly');
        renderTableBody(allData.data, weeklyWeeks, 'weekly');
    }
    
    function renderYearlyData() {
        console.log('Rendering yearly data...');
        if (!allData) {
            console.error('No data available for yearly rendering');
            return;
        }
        
        // Show data by year - group weeks by year
        const yearlyData = groupWeeksByYear(allData.weeks);
        console.log('Yearly data:', yearlyData);
        
        renderTableHeaders(yearlyData, 'yearly');
        renderTableBody(allData.data, yearlyData, 'yearly');
    }
    
    function groupWeeksByYear(weeks) {
        const yearGroups = {};
        
        weeks.forEach(week => {
            const year = week.startDate.split('-')[0];
            if (!yearGroups[year]) {
                yearGroups[year] = {
                    id: `year_${year}`,
                    label: year,
                    startDate: `${year}-01-01`,
                    status: 'archived',
                    weeks: []
                };
            }
            yearGroups[year].weeks.push(week);
        });
        
        return Object.values(yearGroups).sort((a, b) => b.label.localeCompare(a.label));
    }
    
    function aggregateYearlyData(metricData, weeks, metric) {
        // Get all values for this metric across all weeks in the year
        const values = weeks.map(week => {
            const value = safeGetData(metricData, week.id, '');
            return parseNumericValue(value);
        }).filter(v => v !== null);
        
        if (values.length === 0) return '';
        
        // For different metrics, use different aggregation methods
        if (metric.includes('Sessions') || metric.includes('Bookings') || metric.includes('Revenue')) {
            // Sum for volume metrics
            const sum = values.reduce((a, b) => a + b, 0);
            return formatNumericValue(sum, metric);
        } else if (metric.includes('%') || metric.includes('Rate') || metric.includes('Conversion')) {
            // Average for percentage metrics
            const avg = values.reduce((a, b) => a + b, 0) / values.length;
            return formatNumericValue(avg, metric);
        } else {
            // Average for other metrics
            const avg = values.reduce((a, b) => a + b, 0) / values.length;
            return formatNumericValue(avg, metric);
        }
    }
    
    function parseNumericValue(value) {
        if (!value || value === '') return null;
        
        let numValue = parseFloat(value.toString().replace(/[^\d.,-]/g, '').replace(',', '.'));
        
        if (isNaN(numValue)) return null;
        
        // Apply multipliers
        if (value.includes('M€') || value.includes('M')) {
            numValue *= 1000000;
        } else if (value.includes('K€') || value.includes('K')) {
            numValue *= 1000;
        } else if (value.includes('%')) {
            numValue = numValue / 100;
        }
        
        return numValue;
    }
    
    function formatNumericValue(value, metric) {
        if (value === null || isNaN(value)) return '';
        
        if (metric.includes('%') || metric.includes('Rate') || metric.includes('Conversion')) {
            return `${(value * 100).toFixed(1)}%`;
        } else if (metric.includes('€') || metric.includes('Revenue') || metric.includes('Basket')) {
            if (value >= 1000000) {
                return `${(value / 1000000).toFixed(1)}M€`;
            } else if (value >= 1000) {
                return `${(value / 1000).toFixed(1)}K€`;
            } else {
                return `${value.toFixed(0)}€`;
            }
        } else {
            if (value >= 1000000) {
                return `${(value / 1000000).toFixed(1)}M`;
            } else if (value >= 1000) {
                return `${(value / 1000).toFixed(1)}K`;
            } else {
                return `${value.toFixed(0)}`;
            }
        }
    }

    function initializeApp() {
        console.log('Initializing Data History app...');
        
        // Verify critical DOM elements exist for the new modular structure
        const requiredElements = [
            'sessions-weekly-header', 'sessions-weekly-data', 'sessions-weekly-canvas',
            'sessions-yoy-header', 'sessions-yoy-data', 'sessions-yoy-canvas',
            'revenue-weekly-header', 'revenue-weekly-data', 'revenue-weekly-canvas',
            'revenue-yoy-header', 'revenue-yoy-data', 'revenue-yoy-canvas',
            'basket-weekly-header', 'basket-weekly-data', 'basket-weekly-canvas',
            'basket-yoy-header', 'basket-yoy-data', 'basket-yoy-canvas',
            'conversion-weekly-header', 'conversion-weekly-data', 'conversion-weekly-canvas',
            'conversion-yoy-header', 'conversion-yoy-data', 'conversion-yoy-canvas',
            'bookings-weekly-header', 'bookings-weekly-data', 'bookings-weekly-canvas',
            'bookings-yoy-header', 'bookings-yoy-data', 'bookings-yoy-canvas',
            'connection-status', 'online-users', 'loading'
        ];
        
        const missingElements = requiredElements.filter(id => !document.getElementById(id));
        if (missingElements.length > 0) {
            console.error('Missing required DOM elements:', missingElements);
            setTimeout(initializeApp, 100); // Retry after 100ms
            return;
        }
        
        try {
            showLoading(true);
            
            // Initialize in sequence with error handling
            // Skip WebSocket and Yjs initialization for now
            // setTimeout(() => {
            //     try {
            //         initializeWebSocket();
            //     } catch (error) {
            //         console.error('WebSocket initialization failed:', error);
            //     }
            // }, 50);
            
            // setTimeout(() => {
            //     try {
            //         initializeYjs();
            //     } catch (error) {
            //         console.error('Yjs initialization failed:', error);
            //     }
            // }, 100);
            
            setTimeout(() => {
                try {
                    setupEventListeners();
                } catch (error) {
                    console.error('Event listeners setup failed:', error);
                }
            }, 150);
            
            setTimeout(() => {
                try {
                    loadInitialData();
                } catch (error) {
                    console.error('Initial data loading failed:', error);
                    showLoading(false);
                }
            }, 200);
            
        } catch (error) {
            console.error('App initialization failed:', error);
            showLoading(false);
        }
    }

    function initializeWebSocket() {
        socket = io();
        
        socket.on('connect', () => {
            updateConnectionStatus(true);
            console.log('Connected to server');
        });

        socket.on('disconnect', () => {
            updateConnectionStatus(false);
            console.log('Disconnected from server');
        });

        socket.on('user-joined', (user) => {
            addOnlineUser(user);
        });

        socket.on('user-left', (userId) => {
            removeOnlineUser(userId);
        });

        socket.on('users-list', (users) => {
            updateOnlineUsers(users);
        });
    }

    function initializeYjs() {
        // Skip Yjs initialization for now
        console.log('Yjs initialization skipped');
        // ydoc = new Y.Doc();
        // yTable = ydoc.getMap('data-table');
        
        // // Initialize with default structure if empty
        // if (yTable.size === 0) {
        //     initializeTableStructure();
        // }

        // // Listen for changes
        // yTable.observe((event) => {
        //     renderTable();
        // });

        // // Connect to collaborative provider
        // provider = new Y.WebsocketProvider('ws://localhost:3001', 'data-history', ydoc);
        
        // provider.on('status', (event) => {
        //     updateConnectionStatus(event.status === 'connected');
        // });

        // provider.on('sync', () => {
        //     renderTable();
        //     showLoading(false);
        // });
    }

    function initializeTableStructure() {
        const weeks = yTable.get('weeks') || new Y.Array();
        if (weeks.length === 0) {
            // Add current week if no weeks exist
            const currentWeek = {
                id: generateWeekId(),
                label: `Semaine ${getWeekNumber()}`,
                startDate: getCurrentWeekStart(),
                status: 'active'
            };
            weeks.push([currentWeek]);
            yTable.set('weeks', weeks);
        }

        // Initialize data structure - will be populated by loadInitialData
        const data = yTable.get('data') || new Y.Map();
        yTable.set('data', data);
    }

    function renderTable() {
        // This function is deprecated, use renderModuleData instead
        console.warn('renderTable() is deprecated, use renderModuleData() instead');
        if (allData) {
            renderModuleData(currentModule);
        }
    }

    function renderTableHeaders(weeks, module = 'weekly') {
        const prefix = module === 'weekly' ? 'weekly' : 'yearly';
        const weekRow = document.getElementById(`${prefix}-week-row`);
        const dateRow = document.getElementById(`${prefix}-date-row`);
        const statusRow = document.getElementById(`${prefix}-status-row`);

        // Check if all required elements exist
        if (!weekRow || !dateRow || !statusRow) {
            console.error('Table header elements not found:', {
                weekRow: !!weekRow,
                dateRow: !!dateRow,
                statusRow: !!statusRow
            });
            return;
        }

        // Clear existing week headers
        weekRow.querySelectorAll('.week-cell').forEach(cell => cell.remove());
        dateRow.querySelectorAll('.date-cell').forEach(cell => cell.remove());
        statusRow.querySelectorAll('.status-cell').forEach(cell => cell.remove());

        if (!Array.isArray(weeks) || weeks.length === 0) {
            console.warn('No weeks data to render');
            return;
        }

        weeks.forEach(week => {
            if (!week || !week.label) {
                console.warn('Invalid week data:', week);
                return;
            }

            try {
                // Week header
                const weekCell = document.createElement('th');
                weekCell.className = 'week-header week-cell';
                weekCell.textContent = week.label || 'N/A';
                weekRow.appendChild(weekCell);

                // Date header - afficher la date complète
                const dateCell = document.createElement('th');
                dateCell.className = 'week-header date-cell';
                dateCell.textContent = formatDateFull(week.startDate) || 'N/A';
                dateRow.appendChild(dateCell);

                // Week number header - afficher le numéro de semaine
                const weekNumberCell = document.createElement('th');
                weekNumberCell.className = 'week-header status-cell';
                weekNumberCell.textContent = `S${getWeekNumber(week.startDate)}`;
                statusRow.appendChild(weekNumberCell);
            } catch (error) {
                console.error('Error creating week header for:', week, error);
            }
        });
    }

    // Helper function to safely set element content
    function safeSetContent(elementId, content, isHTML = false) {
        const element = document.getElementById(elementId);
        if (element) {
            if (isHTML) {
                element.innerHTML = content;
            } else {
                element.textContent = content;
            }
            return true;
        } else {
            console.warn(`Element with ID '${elementId}' not found`);
            return false;
        }
    }

    // Helper function to safely get data from Yjs or regular objects
    function safeGetData(dataSource, key, defaultValue = null) {
        if (!dataSource) return defaultValue;
        
        // Check if it's a Yjs Map
        if (dataSource.get && typeof dataSource.get === 'function') {
            return dataSource.get(key) || defaultValue;
        }
        
        // Regular object/Map
        if (dataSource[key] !== undefined) {
            return dataSource[key];
        }
        
        return defaultValue;
    }

    function renderTableBody(data, weeks, module = 'weekly') {
        const prefix = module === 'weekly' ? 'weekly' : 'yearly';
        const tbody = document.getElementById(`${prefix}-data-body`);
        if (!tbody) {
            console.error('Table body element not found');
            return;
        }
        
        tbody.innerHTML = '';

        // Render sections in order
        SECTION_ORDER.forEach(sectionKey => {
            const sectionData = safeGetData(data, sectionKey, {});
            const metrics = Object.keys(sectionData);
            
            if (metrics.length === 0) return; // Skip empty sections
            
            metrics.forEach((metric, metricIndex) => {
                const row = document.createElement('tr');
                
                // Section header (only for first metric of each section)
                if (metricIndex === 0) {
                    const sectionCell = document.createElement('td');
                    sectionCell.className = 'channel-header';
                    sectionCell.rowSpan = metrics.length;
                    sectionCell.textContent = SECTION_LABELS[sectionKey] || sectionKey;
                    sectionCell.style.writingMode = 'horizontal-tb'; // Override for long section names
                    sectionCell.style.textOrientation = 'mixed';
                    sectionCell.style.padding = '12px 8px';
                    sectionCell.style.fontSize = '0.8rem';
                    sectionCell.style.lineHeight = '1.2';
                    row.appendChild(sectionCell);
                }
                
                // Metric header
                const metricCell = document.createElement('td');
                metricCell.className = 'metric-header';
                metricCell.textContent = metric;
                metricCell.style.minWidth = '200px'; // Ensure readability
                row.appendChild(metricCell);
                
                // Data cells for each week/year
                weeks.forEach(week => {
                    const dataCell = document.createElement('td');
                    dataCell.className = 'editable-cell';
                    dataCell.contentEditable = true;
                    dataCell.dataset.section = sectionKey;
                    dataCell.dataset.metric = metric;
                    dataCell.dataset.week = week.id;
                    
                    const metricData = safeGetData(sectionData, metric, {});
                    let cellValue = '';
                    
                    if (module === 'yearly' && week.weeks) {
                        // For yearly view, aggregate data from all weeks in the year
                        cellValue = aggregateYearlyData(metricData, week.weeks, metric);
                    } else {
                        // For weekly view, get individual week data
                        cellValue = safeGetData(metricData, week.id, '');
                    }
                    
                    dataCell.textContent = cellValue;
                    
                    // Add event listeners for collaborative editing (only for weekly)
                    if (module === 'weekly') {
                        setupCellEditor(dataCell, metricData, week.id, sectionKey);
                    }
                    
                    row.appendChild(dataCell);
                });
                
                tbody.appendChild(row);
            });
        });
    }

    function setupCellEditor(cell, metricData, weekId, sectionKey) {
        let isUpdating = false;

        cell.addEventListener('input', (e) => {
            if (isUpdating) return;
            
            const value = e.target.textContent;
            
            // Update data based on type (Yjs or regular object)
            if (metricData && metricData.set && typeof metricData.set === 'function') {
                metricData.set(weekId, value);
            } else if (typeof metricData === 'object') {
                metricData[weekId] = value;
            }
            
            // Visual feedback
            cell.style.backgroundColor = '#d4edda';
            setTimeout(() => {
                cell.style.backgroundColor = '';
            }, 300);
            
            // Mark as edited for potential sync back to SQLite
            cell.dataset.edited = 'true';
        });

        cell.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                e.target.blur();
            }
            if (e.key === 'Tab') {
                e.preventDefault();
                moveFocus(e.target, e.shiftKey ? -1 : 1);
            }
        });

        // Listen for remote changes (only for Yjs objects)
        if (metricData && metricData.observe && typeof metricData.observe === 'function') {
            metricData.observe((event) => {
                if (event.changes.keys.has(weekId)) {
                    isUpdating = true;
                    cell.textContent = safeGetData(metricData, weekId, '');
                    isUpdating = false;
                }
            });
        }
    }

    function setupEventListeners() {
        const eventElements = [
            { id: 'add-week', handler: addWeek },
            { id: 'save-data', handler: saveData },
            { id: 'export-csv', handler: exportCSV },
            { id: 'export-json', handler: exportJSON }
        ];
        
        eventElements.forEach(({ id, handler }) => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('click', handler);
            } else {
                console.warn(`Button element not found: ${id}`);
            }
        });
    }

    function addWeek() {
        const weeks = safeGetData(yTable, 'weeks', []);
        const weeksArray = (weeks && weeks.toArray && typeof weeks.toArray === 'function') 
            ? weeks.toArray() 
            : (Array.isArray(weeks) ? weeks : []);
            
        const newWeek = {
            id: generateWeekId(),
            label: `Semaine ${weeksArray.length + 1}`,
            startDate: getNextWeekStart(weeksArray.length),
            status: 'active'
        };
        
        if (weeks && weeks.push && typeof weeks.push === 'function') {
            weeks.push([newWeek]);
        }
        renderTable();
    }

    function saveData() {
        // Collect all edited cells
        const editedCells = document.querySelectorAll('.editable-cell[data-edited="true"]');
        
        if (editedCells.length === 0) {
            showToast('Aucune modification à sauvegarder', 'info');
            return;
        }
        
        const changes = [];
        editedCells.forEach(cell => {
            changes.push({
                section: cell.dataset.section,
                metric: cell.dataset.metric,
                week_id: cell.dataset.week,
                value: cell.textContent.trim()
            });
        });
        
        // Send changes to SQLite
        fetch('/api/data-history/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ changes: changes })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(`${data.updated_count} modifications sauvegardées en base`, 'success');
                
                // Clear edited flags
                editedCells.forEach(cell => {
                    cell.removeAttribute('data-edited');
                });
                
                if (data.errors && data.errors.length > 0) {
                    console.warn('Erreurs lors de la sauvegarde:', data.errors);
                    showToast(`Attention: ${data.errors.length} erreurs détectées`, 'warning');
                }
            } else {
                showToast('Erreur lors de la sauvegarde: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Erreur sauvegarde:', error);
            showToast('Erreur réseau lors de la sauvegarde', 'danger');
        });
        
        // Also save to collaborative document if available
        if (socket) {
            socket.emit('save-snapshot', {
                docId: 'data-history',
                timestamp: new Date().toISOString(),
                changesCount: changes.length
            });
        }
    }

    function exportCSV() {
        const weeks = safeGetData(yTable, 'weeks', []);
        const data = safeGetData(yTable, 'data', {});
        
        const weeksArray = (weeks && weeks.toArray && typeof weeks.toArray === 'function') 
            ? weeks.toArray() 
            : (Array.isArray(weeks) ? weeks : []);
        
        let csv = 'Section,Metric,' + weeksArray.map(w => w.label).join(',') + '\n';
        
        SECTION_ORDER.forEach(sectionKey => {
            const sectionData = safeGetData(data, sectionKey, {});
            Object.keys(sectionData).forEach(metric => {
                const metricData = safeGetData(sectionData, metric, {});
                const row = [SECTION_LABELS[sectionKey] || sectionKey, metric];
                weeksArray.forEach(week => {
                    row.push(safeGetData(metricData, week.id, ''));
                });
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });
        });
        
        downloadFile(csv, 'cpfr-data-history.csv', 'text/csv');
    }

    function exportJSON() {
        const weeks = safeGetData(yTable, 'weeks', []);
        const data = safeGetData(yTable, 'data', {});
        
        const weeksArray = (weeks && weeks.toArray && typeof weeks.toArray === 'function') 
            ? weeks.toArray() 
            : (Array.isArray(weeks) ? weeks : []);
        
        const exportData = {
            export_timestamp: new Date().toISOString(),
            weeks: weeksArray,
            data: {}
        };
        
        SECTION_ORDER.forEach(sectionKey => {
            const sectionData = safeGetData(data, sectionKey, {});
            if (Object.keys(sectionData).length > 0) {
                exportData.data[sectionKey] = {};
                Object.keys(sectionData).forEach(metric => {
                    const metricData = safeGetData(sectionData, metric, {});
                    
                    // Handle both Yjs Maps and regular objects
                    if (metricData && metricData.entries && typeof metricData.entries === 'function') {
                        exportData.data[sectionKey][metric] = Object.fromEntries(metricData.entries());
                    } else if (typeof metricData === 'object') {
                        exportData.data[sectionKey][metric] = { ...metricData };
                    } else {
                        exportData.data[sectionKey][metric] = {};
                    }
                });
            }
        });
        
        downloadFile(JSON.stringify(exportData, null, 2), 'cpfr-data-history.json', 'application/json');
    }

    // Utility functions
    function generateWeekId() {
        return 'week_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function getCurrentWeekStart() {
        const now = new Date();
        const monday = new Date(now.setDate(now.getDate() - now.getDay() + 1));
        return monday.toISOString().split('T')[0];
    }

    function getNextWeekStart(weekIndex) {
        const now = new Date();
        const monday = new Date(now.setDate(now.getDate() - now.getDay() + 1 + (weekIndex * 7)));
        return monday.toISOString().split('T')[0];
    }

    function getWeekNumber() {
        const now = new Date();
        const start = new Date(now.getFullYear(), 0, 1);
        return Math.ceil(((now - start) / 86400000 + start.getDay()) / 7);
    }

    function formatDate(dateString) {
        try {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'Invalid Date';
            
            return date.toLocaleDateString('fr-FR', {
                month: 'short',
                day: 'numeric'
            });
        } catch (error) {
            console.error('Error formatting date:', dateString, error);
            return 'N/A';
        }
    }
    
    function formatDateFull(dateString) {
        try {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'Invalid Date';
            
            return date.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        } catch (error) {
            console.error('Error formatting full date:', dateString, error);
            return 'N/A';
        }
    }
    
    function getWeekNumber(dateString) {
        try {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'N/A';
            
            // Calculer le numéro de semaine ISO
            const tempDate = new Date(date.valueOf());
            const dayNum = (date.getDay() + 6) % 7;
            tempDate.setDate(tempDate.getDate() - dayNum + 3);
            const firstThursday = tempDate.valueOf();
            tempDate.setMonth(0, 1);
            if (tempDate.getDay() !== 4) {
                tempDate.setMonth(0, 1 + ((4 - tempDate.getDay()) + 7) % 7);
            }
            return 1 + Math.ceil((firstThursday - tempDate) / 604800000);
        } catch (error) {
            console.error('Error calculating week number:', dateString, error);
            return 'N/A';
        }
    }

    function moveFocus(currentCell, direction) {
        const cells = Array.from(document.querySelectorAll('.editable-cell'));
        const currentIndex = cells.indexOf(currentCell);
        const nextIndex = currentIndex + direction;
        
        if (nextIndex >= 0 && nextIndex < cells.length) {
            cells[nextIndex].focus();
        }
    }

    function updateConnectionStatus(connected) {
        const status = document.getElementById('connection-status');
        if (!status) {
            console.warn('Connection status element not found');
            return;
        }
        
        if (connected) {
            status.className = 'badge bg-success ms-2';
            status.textContent = '●';
        } else {
            status.className = 'badge bg-danger ms-2';
            status.textContent = '●';
        }
    }

    function updateOnlineUsers(users) {
        const container = document.getElementById('online-users');
        if (!container) {
            console.warn('Online users container not found');
            return;
        }
        
        container.innerHTML = '';
        
        if (!Array.isArray(users)) {
            console.warn('Users data is not an array:', users);
            return;
        }
        
        users.forEach(user => {
            if (!user) return;
            
            const badge = document.createElement('div');
            badge.className = 'user-badge';
            badge.innerHTML = `
                <div class="user-indicator"></div>
                <span>${user.name || 'Anonyme'}</span>
            `;
            container.appendChild(badge);
        });
    }

    function addOnlineUser(user) {
        onlineUsers.set(user.id, user);
        updateOnlineUsers(Array.from(onlineUsers.values()));
    }

    function removeOnlineUser(userId) {
        onlineUsers.delete(userId);
        updateOnlineUsers(Array.from(onlineUsers.values()));
    }

    function showLoading(show) {
        const loading = document.getElementById('loading');
        if (!loading) {
            console.warn('Loading element not found');
            return;
        }
        loading.style.display = show ? 'block' : 'none';
    }

    function showToast(message, type = 'info') {
        // Simple toast implementation
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 250px;';
        toast.textContent = message;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    function downloadFile(content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function loadInitialData() {
        console.log('Loading initial data from API...');
        
        // Load any existing data from the server
        fetch('/api/data-history/initial')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Data loaded successfully:', data);
                if (data && (data.weeks || data.data)) {
                    // Store data globally
                    allData = data;
                    
                    // Populate all modules immediately
                    populateSessionsModule(data);
                    populateRevenueModule(data);
                    populateBasketModule(data);
                    populateConversionModule(data);
                    populateBookingsModule(data);
                    console.log('All modules populated');
                } else {
                    console.warn('No data received from API');
                }
                showLoading(false);
            })
            .catch(error => {
                console.error('Error loading initial data:', error);
                showLoading(false);
                // Show error message to user
                showToast('Erreur lors du chargement des données', 'danger');
            });
    }

    function populateSessionsModule(data) {
        try {
            console.log('Populating sessions module with data:', data);
            
            if (!data || !data.weeks || !data.data) {
                console.error('Invalid data structure for sessions module');
                return;
            }
            
            // Get sessions data from SLIDE_31_GLOBAL section
            const globalData = data.data['SLIDE_31_GLOBAL'];
            if (!globalData || !globalData['Sessions']) {
                console.error('Sessions data not found in SLIDE_31_GLOBAL');
                console.log('Available sections:', Object.keys(data.data));
                console.log('SLIDE_31_GLOBAL content:', globalData);
                return;
            }
            
            // Real data points: 342K current, -4% VS LW, +6% VS LY
            const currentWeekValue = '342K'; // Current week (July 15, 2025)
            
            // Weekly comparison data (VS LW = -4%)
            const previousWeekValue = '356K'; // 342K / (1 - 0.04) = ~356K
            const weeklyData = [
                {
                    id: 'week_previous',
                    label: 'Semaine 08/07/2025',
                    startDate: '2025-07-08'
                },
                {
                    id: 'week_current', 
                    label: 'Semaine 15/07/2025',
                    startDate: '2025-07-15'
                }
            ];
            const weeklyValues = {
                'week_previous': previousWeekValue,
                'week_current': currentWeekValue
            };
            
            // Year on Year comparison data (VS LY = +6%)
            const lastYearValue = '323K'; // 342K / (1 + 0.06) = ~323K
            const yoyData = [
                {
                    id: 'year_previous',
                    label: 'Semaine 15/07/2024',
                    startDate: '2024-07-15'
                },
                {
                    id: 'year_current', 
                    label: 'Semaine 15/07/2025',
                    startDate: '2025-07-15'
                }
            ];
            const yoyValues = {
                'year_previous': lastYearValue,
                'year_current': currentWeekValue
            };
            
            console.log('Weekly data:', weeklyValues);
            console.log('Year on Year data:', yoyValues);
            
            // Populate Weekly tab
            populateSessionsTable('sessions-weekly-header', 'sessions-weekly-data', weeklyData, weeklyValues);
            initializeSessionsChart('sessions-weekly-canvas', weeklyData, weeklyValues, 'Weekly');
            
            // Populate Year on Year tab
            populateSessionsTable('sessions-yoy-header', 'sessions-yoy-data', yoyData, yoyValues);
            initializeSessionsChart('sessions-yoy-canvas', yoyData, yoyValues, 'Year on Year');
            
        } catch (error) {
            console.error('Error populating sessions module:', error);
            showToast('Erreur lors de la population du module sessions', 'danger');
        }
    }

    function populateSessionsTable(headerId, dataId, weeks, sessionsData) {
        try {
            // Populate table headers
            const headerRow = document.getElementById(headerId);
            if (headerRow) {
                headerRow.innerHTML = '';
                
                weeks.forEach(week => {
                    const th = document.createElement('th');
                    th.className = 'week-header';
                    th.textContent = week.label;
                    headerRow.appendChild(th);
                });
                console.log('Headers populated for', headerId, 'with', weeks.length, 'weeks');
            } else {
                console.error(headerId + ' element not found');
            }
            
            // Populate table data
            const dataRow = document.getElementById(dataId);
            if (dataRow) {
                dataRow.innerHTML = '';
                
                weeks.forEach(week => {
                    const td = document.createElement('td');
                    td.className = 'text-center';
                    td.textContent = sessionsData[week.id] || '';
                    dataRow.appendChild(td);
                });
                console.log('Data populated for', dataId, 'with', weeks.length, 'values');
            } else {
                console.error(dataId + ' element not found');
            }
            
        } catch (error) {
            console.error('Error populating table:', error);
        }
    }

    function populateRevenueModule(data) {
        try {
            console.log('Populating revenue module with data:', data);
            
            // Real data points: 2,27M€ current, -12% VS LW, +11% VS LY
            const currentWeekValue = '2,27M€'; // Current week (July 15, 2025)
            
            // Weekly comparison data (VS LW = -12%)
            const previousWeekValue = '2,58M€'; // 2.27M / (1 - 0.12) = ~2.58M
            const weeklyData = [
                {
                    id: 'week_previous',
                    label: 'Semaine 08/07/2025',
                    startDate: '2025-07-08'
                },
                {
                    id: 'week_current', 
                    label: 'Semaine 15/07/2025',
                    startDate: '2025-07-15'
                }
            ];
            const weeklyValues = {
                'week_previous': previousWeekValue,
                'week_current': currentWeekValue
            };
            
            // Year on Year comparison data (VS LY = +11%)
            const lastYearValue = '2,05M€'; // 2.27M / (1 + 0.11) = ~2.05M
            const yoyData = [
                {
                    id: 'year_previous',
                    label: 'Semaine 15/07/2024',
                    startDate: '2024-07-15'
                },
                {
                    id: 'year_current', 
                    label: 'Semaine 15/07/2025',
                    startDate: '2025-07-15'
                }
            ];
            const yoyValues = {
                'year_previous': lastYearValue,
                'year_current': currentWeekValue
            };
            
            console.log('Revenue Weekly data:', weeklyValues);
            console.log('Revenue Year on Year data:', yoyValues);
            
            // Populate Weekly tab
            populateMetricTable('revenue-weekly-header', 'revenue-weekly-data', weeklyData, weeklyValues);
            initializeMetricChart('revenue-weekly-canvas', weeklyData, weeklyValues, 'Weekly', 'Revenue');
            
            // Populate Year on Year tab
            populateMetricTable('revenue-yoy-header', 'revenue-yoy-data', yoyData, yoyValues);
            initializeMetricChart('revenue-yoy-canvas', yoyData, yoyValues, 'Year on Year', 'Revenue');
            
        } catch (error) {
            console.error('Error populating revenue module:', error);
            showToast('Erreur lors de la population du module revenue', 'danger');
        }
    }

    function populateMetricTable(headerId, dataId, weeks, metricData) {
        try {
            // Populate table headers
            const headerRow = document.getElementById(headerId);
            if (headerRow) {
                headerRow.innerHTML = '';
                
                weeks.forEach(week => {
                    const th = document.createElement('th');
                    th.className = 'week-header';
                    th.textContent = week.label;
                    headerRow.appendChild(th);
                });
                console.log('Headers populated for', headerId, 'with', weeks.length, 'weeks');
            } else {
                console.error(headerId + ' element not found');
            }
            
            // Populate table data
            const dataRow = document.getElementById(dataId);
            if (dataRow) {
                dataRow.innerHTML = '';
                
                weeks.forEach(week => {
                    const td = document.createElement('td');
                    td.className = 'text-center';
                    td.textContent = metricData[week.id] || '';
                    dataRow.appendChild(td);
                });
                console.log('Data populated for', dataId, 'with', weeks.length, 'values');
            } else {
                console.error(dataId + ' element not found');
            }
            
        } catch (error) {
            console.error('Error populating metric table:', error);
        }
    }

    function populateBasketModule(data) {
        try {
            console.log('Populating basket module with data:', data);
            
            // Real data points: 917€ current, +8% VS LW, -15% VS LY
            const currentWeekValue = '917€'; // Current week (July 15, 2025)
            
            // Weekly comparison data (VS LW = +8%)
            const previousWeekValue = '849€'; // 917 / (1 + 0.08) = ~849
            const weeklyData = [
                {
                    id: 'week_previous',
                    label: 'Semaine 08/07/2025',
                    startDate: '2025-07-08'
                },
                {
                    id: 'week_current', 
                    label: 'Semaine 15/07/2025',
                    startDate: '2025-07-15'
                }
            ];
            const weeklyValues = {
                'week_previous': previousWeekValue,
                'week_current': currentWeekValue
            };
            
            // Year on Year comparison data (VS LY = -15%)
            const lastYearValue = '1078€'; // 917 / (1 - 0.15) = ~1078
            const yoyData = [
                {
                    id: 'year_previous',
                    label: 'Semaine 15/07/2024',
                    startDate: '2024-07-15'
                },
                {
                    id: 'year_current', 
                    label: 'Semaine 15/07/2025',
                    startDate: '2025-07-15'
                }
            ];
            const yoyValues = {
                'year_previous': lastYearValue,
                'year_current': currentWeekValue
            };
            
            console.log('Basket Weekly data:', weeklyValues);
            console.log('Basket Year on Year data:', yoyValues);
            
            // Populate Weekly tab
            populateMetricTable('basket-weekly-header', 'basket-weekly-data', weeklyData, weeklyValues);
            initializeMetricChart('basket-weekly-canvas', weeklyData, weeklyValues, 'Weekly', 'Average Basket');
            
            // Populate Year on Year tab
            populateMetricTable('basket-yoy-header', 'basket-yoy-data', yoyData, yoyValues);
            initializeMetricChart('basket-yoy-canvas', yoyData, yoyValues, 'Year on Year', 'Average Basket');
            
        } catch (error) {
            console.error('Error populating basket module:', error);
            showToast('Erreur lors de la population du module panier', 'danger');
        }
    }

    function populateConversionModule(data) {
        try {
            console.log('Populating conversion module with data:', data);
            
            // Real data points: 0,53% current, -14% VS LW, +12% VS LY
            const currentWeekValue = '0,53%'; // Current week (July 15, 2025)
            
            // Weekly comparison data (VS LW = -14%)
            const previousWeekValue = '0,62%'; // 0.53 / (1 - 0.14) = ~0.62
            const weeklyData = [
                {
                    id: 'week_previous',
                    label: 'Semaine 08/07/2025',
                    startDate: '2025-07-08'
                },
                {
                    id: 'week_current', 
                    label: 'Semaine 15/07/2025',
                    startDate: '2025-07-15'
                }
            ];
            const weeklyValues = {
                'week_previous': previousWeekValue,
                'week_current': currentWeekValue
            };
            
            // Year on Year comparison data (VS LY = +12%)
            const lastYearValue = '0,47%'; // 0.53 / (1 + 0.12) = ~0.47
            const yoyData = [
                {
                    id: 'year_previous',
                    label: 'Semaine 15/07/2024',
                    startDate: '2024-07-15'
                },
                {
                    id: 'year_current', 
                    label: 'Semaine 15/07/2025',
                    startDate: '2025-07-15'
                }
            ];
            const yoyValues = {
                'year_previous': lastYearValue,
                'year_current': currentWeekValue
            };
            
            console.log('Conversion Weekly data:', weeklyValues);
            console.log('Conversion Year on Year data:', yoyValues);
            
            // Populate Weekly tab
            populateMetricTable('conversion-weekly-header', 'conversion-weekly-data', weeklyData, weeklyValues);
            initializeMetricChart('conversion-weekly-canvas', weeklyData, weeklyValues, 'Weekly', 'Conversion Rate');
            
            // Populate Year on Year tab
            populateMetricTable('conversion-yoy-header', 'conversion-yoy-data', yoyData, yoyValues);
            initializeMetricChart('conversion-yoy-canvas', yoyData, yoyValues, 'Year on Year', 'Conversion Rate');
            
        } catch (error) {
            console.error('Error populating conversion module:', error);
            showToast('Erreur lors de la population du module conversion', 'danger');
        }
    }

    function populateBookingsModule(data) {
        try {
            console.log('Populating bookings module with data:', data);
            
            // Real data points: 2 475 current, -18% VS LW, +29% VS LY
            const currentWeekValue = '2 475'; // Current week (July 15, 2025)
            
            // Weekly comparison data (VS LW = -18%)
            const previousWeekValue = '3 018'; // 2475 / (1 - 0.18) = ~3018
            const weeklyData = [
                {
                    id: 'week_previous',
                    label: 'Semaine 08/07/2025',
                    startDate: '2025-07-08'
                },
                {
                    id: 'week_current', 
                    label: 'Semaine 15/07/2025',
                    startDate: '2025-07-15'
                }
            ];
            const weeklyValues = {
                'week_previous': previousWeekValue,
                'week_current': currentWeekValue
            };
            
            // Year on Year comparison data (VS LY = +29%)
            const lastYearValue = '1 919'; // 2475 / (1 + 0.29) = ~1919
            const yoyData = [
                {
                    id: 'year_previous',
                    label: 'Semaine 15/07/2024',
                    startDate: '2024-07-15'
                },
                {
                    id: 'year_current', 
                    label: 'Semaine 15/07/2025',
                    startDate: '2025-07-15'
                }
            ];
            const yoyValues = {
                'year_previous': lastYearValue,
                'year_current': currentWeekValue
            };
            
            console.log('Bookings Weekly data:', weeklyValues);
            console.log('Bookings Year on Year data:', yoyValues);
            
            // Populate Weekly tab
            populateMetricTable('bookings-weekly-header', 'bookings-weekly-data', weeklyData, weeklyValues);
            initializeMetricChart('bookings-weekly-canvas', weeklyData, weeklyValues, 'Weekly', 'Bookings');
            
            // Populate Year on Year tab
            populateMetricTable('bookings-yoy-header', 'bookings-yoy-data', yoyData, yoyValues);
            initializeMetricChart('bookings-yoy-canvas', yoyData, yoyValues, 'Year on Year', 'Bookings');
            
        } catch (error) {
            console.error('Error populating bookings module:', error);
            showToast('Erreur lors de la population du module réservations', 'danger');
        }
    }

    function initializeSessionsChart(canvasId, weeks, sessionsData, chartType) {
        try {
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.error('Sessions canvas not found:', canvasId);
                return;
            }
            
            // Convert session values to numbers for Chart.js
            const chartValues = weeks.map(week => {
                const value = sessionsData[week.id] || '';
                if (value.includes('K')) {
                    return parseFloat(value.replace('K', '')) * 1000;
                } else if (value.includes('M')) {
                    return parseFloat(value.replace('M', '')) * 1000000;
                } else {
                    return parseFloat(value) || 0;
                }
            });
            
            // Chart.js 4.5.0 configuration
            const data = {
                labels: weeks.map(w => w.label),
                datasets: [{
                    label: `Nb of sessions - ${chartType}`,
                    data: chartValues,
                    fill: false,
                    borderColor: 'rgb(13, 110, 253)', // Bootstrap primary blue
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    pointBackgroundColor: 'rgb(13, 110, 253)',
                    pointBorderColor: 'rgb(13, 110, 253)',
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    tension: 0.1,
                    borderWidth: 2
                }]
            };
            
            const config = {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const formatted = value >= 1000000 ? `${(value/1000000).toFixed(1)}M` : 
                                                     value >= 1000 ? `${(value/1000).toFixed(0)}K` : 
                                                     value.toString();
                                    return `Sessions: ${formatted}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: chartType === 'Weekly' ? 'Semaines' : 'Années'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Sessions'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value >= 1000000 ? `${(value/1000000).toFixed(1)}M` : 
                                           value >= 1000 ? `${(value/1000).toFixed(0)}K` : 
                                           value.toString();
                                }
                            }
                        }
                    }
                }
            };
            
            // Create the chart
            const ctx = canvas.getContext('2d');
            const sessionsChart = new Chart(ctx, config);
            
            console.log(`Chart.js line chart initialized for ${chartType} with data:`, chartValues);
            
        } catch (error) {
            console.error('Error initializing sessions chart:', error);
        }
    }

    function initializeMetricChart(canvasId, weeks, metricData, chartType, metricName) {
        try {
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.error('Metric canvas not found:', canvasId);
                return;
            }
            
            // Convert metric values to numbers for Chart.js
            const chartValues = weeks.map(week => {
                const value = metricData[week.id] || '';
                if (value.includes('M€')) {
                    return parseFloat(value.replace('M€', '').replace(',', '.')) * 1000000;
                } else if (value.includes('K€')) {
                    return parseFloat(value.replace('K€', '').replace(',', '.')) * 1000;
                } else if (value.includes('€')) {
                    return parseFloat(value.replace('€', '').replace(',', '.'));
                } else if (value.includes('K')) {
                    return parseFloat(value.replace('K', '').replace(',', '.')) * 1000;
                } else if (value.includes('M')) {
                    return parseFloat(value.replace('M', '').replace(',', '.')) * 1000000;
                } else if (value.includes('%')) {
                    return parseFloat(value.replace('%', '').replace(',', '.'));
                } else {
                    return parseFloat(value.replace(',', '.')) || 0;
                }
            });
            
            // Chart.js 4.5.0 configuration
            const data = {
                labels: weeks.map(w => w.label),
                datasets: [{
                    label: `${metricName} - ${chartType}`,
                    data: chartValues,
                    fill: false,
                    borderColor: getMetricColor(metricName),
                    backgroundColor: getMetricColor(metricName, 0.1),
                    pointBackgroundColor: getMetricColor(metricName),
                    pointBorderColor: getMetricColor(metricName),
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    tension: 0.1,
                    borderWidth: 2
                }]
            };
            
            const config = {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    let formatted = formatMetricValue(value, metricName);
                                    return `${metricName}: ${formatted}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: chartType === 'Weekly' ? 'Semaines' : 'Années'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: metricName
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatMetricValue(value, metricName);
                                }
                            }
                        }
                    }
                }
            };
            
            // Create the chart
            const ctx = canvas.getContext('2d');
            const metricChart = new Chart(ctx, config);
            
            console.log(`Chart.js line chart initialized for ${metricName} ${chartType} with data:`, chartValues);
            
        } catch (error) {
            console.error('Error initializing metric chart:', error);
        }
    }

    function getMetricColor(metricName, alpha = 1) {
        const colors = {
            'Revenue': alpha === 1 ? 'rgb(25, 135, 84)' : `rgba(25, 135, 84, ${alpha})`, // Green
            'Average Basket': alpha === 1 ? 'rgb(255, 193, 7)' : `rgba(255, 193, 7, ${alpha})`, // Yellow
            'Conversion Rate': alpha === 1 ? 'rgb(220, 53, 69)' : `rgba(220, 53, 69, ${alpha})`, // Red
            'Bookings': alpha === 1 ? 'rgb(111, 66, 193)' : `rgba(111, 66, 193, ${alpha})`, // Purple
            'Sessions': alpha === 1 ? 'rgb(13, 110, 253)' : `rgba(13, 110, 253, ${alpha})` // Blue
        };
        return colors[metricName] || colors['Sessions'];
    }

    function formatMetricValue(value, metricName) {
        if (metricName === 'Revenue' || metricName === 'Average Basket') {
            return value >= 1000000 ? `${(value/1000000).toFixed(2)}M€` : 
                   value >= 1000 ? `${(value/1000).toFixed(0)}K€` : 
                   `${value.toFixed(0)}€`;
        } else if (metricName === 'Conversion Rate') {
            return `${value.toFixed(2)}%`;
        } else if (metricName === 'Bookings') {
            return value >= 1000 ? `${(value/1000).toFixed(1)}K` : value.toString();
        } else { // Sessions
            return value >= 1000000 ? `${(value/1000000).toFixed(1)}M` : 
                   value >= 1000 ? `${(value/1000).toFixed(0)}K` : 
                   value.toString();
        }
    }

    function populateTableWithData(data) {
        try {
            console.log('Populating table with data:', data);
            console.log('Data weeks:', data.weeks);
            console.log('Data sections:', Object.keys(data.data));
            
            // Store data globally
            allData = data;
            
            // Render the current module
            console.log('Rendering module:', currentModule);
            renderModuleData(currentModule);
            
            // Skip Yjs population for now
            // if (yTable && yTable.set && typeof yTable.set === 'function') {
            //     if (data.weeks) {
            //         const weeks = new Y.Array();
            //         data.weeks.forEach(week => weeks.push([week]));
            //         yTable.set('weeks', weeks);
            //     }
            //     
            //     if (data.data) {
            //         const tableData = new Y.Map();
            //         Object.entries(data.data).forEach(([channel, channelData]) => {
            //             const yChannelData = new Y.Map();
            //             Object.entries(channelData).forEach(([metric, metricData]) => {
            //                 const yMetricData = new Y.Map();
            //                 Object.entries(metricData).forEach(([weekId, value]) => {
            //                     yMetricData.set(weekId, value);
            //                 });
            //                 yChannelData.set(metric, yMetricData);
            //             });
            //             tableData.set(channel, yChannelData);
            //         });
            //         yTable.set('data', tableData);
            //     }
            // }
            
        } catch (error) {
            console.error('Error populating table:', error);
            showToast('Erreur lors de la population du tableau', 'danger');
        }
    }
</script>
{% endblock %}